var common={$inputFile:".js-input-file",$inputTextFile:".js-input-txt-file",$uploadBlock:".js-upload-block",$uploadBtn:".js-upload-btn",$switchBtn:".js-switch-btn",initEvents:function(){var t=this;$(window).on({load:function(){$(t.$uploadBtn).on("click",$.proxy(t.opnUploadWindow,t)),$(t.$switchBtn).on("click",$.proxy(t.showCurrentBox,t)),$(".social__btn--like").on("click",$.proxy(t.showSocialBtns,t))}})},opnUploadWindow:function(t){var e=$(t.currentTarget);e.closest(this.$uploadBlock).find(this.$inputFile).click()},setFileName:function(t){var e=$(t.currentTarget);e.closest(this.$uploadBlock).find(this.$inputTextFile).val(e.val().split("\\").pop())},showCurrentBox:function(t){var e=$(t.currentTarget);e.addClass("btn--active").siblings().removeClass("btn--active").closest(".setting__position").find(".block--"+e.data("div")).addClass("active").siblings().removeClass("active"),t.preventDefault()},initRangeSlider:function(){},showSocialBtns:function(t){t.preventDefault(),$(t.currentTarget).closest(".socials").toggleClass("social--open")}},App={defaults:{image:{r:1,width:650,height:535,el:$(".image"),url:"upload/image.jpg"},watermark:{r:1,width:216,height:223,el:$(".watermark"),url:"upload/watermark.png"}},settings:{max_w:650,max_h:535},image:null,watermark:null,border:{x:0,y:0},position:{top:0,left:0},opacity:1,type:"one",init:function(){this.image=this.defaults.image,this.watermark=this.defaults.watermark,$(".setting__buttons-reset").on("click",function(){App.clearForm()}),$(".setting__buttons-submit").on("click",function(t){t.preventDefault(),App.submitForm()}),$(".table__cell").on("click",function(t){$el=$(t.target),$(".table__cell").removeClass("cell--active"),$el.addClass("cell--active"),App.setPos({x:$el.data("x"),y:$el.data("y")})})},setImg:function(t,e){if("image"==t){this.image=e,this.image.el=$(".image"),this.image.el.css("background-image",e.url);var i=e.width,s=e.height,a=1;(e.width>this.settings.max_w||e.width>this.settings.max_w)&&(a=i/s,a>1?(i=this.settings.max_w,s=Math.round(i/a)):(s=this.settings.max_h,i=Math.round(s/a))),this.image.r=a,this.image.el.css("width",i),this.image.el.css("height",s),this.image.el.css("background-image",'url("/web/'+e.url+'")')}else"watermark"==t&&(this.watermark=e,this.watermark.r=a,this.watermark.el=$(".watermark"),this.watermark.el.css("background-image",e.url),this.watermark.el.css("width",e.width),this.watermark.el.css("height",e.height),this.watermark.el.css("background-image",'url("/web/'+e.url+'")'))},setPos:function(t){(t.x||0===t.x)&&(this.position.left="number"==typeof t.x?t.x:this.getCoords("x",t.x)),(t.y||0===t.y)&&(this.position.top="number"==typeof t.y?t.y:this.getCoords("y",t.y)),this.watermark.el.css("left",this.position.left),this.watermark.el.css("top",this.position.top),$("#x").spinner("value",App.position.left),$("#y").spinner("value",App.position.top)},getCoords:function(t,e){var i=0;if("x"==t)switch(e){case"left":i=0;break;case"center":i=this.image.el.width()/2-this.watermark.el.width()/2;break;case"right":i=this.image.el.width()-this.watermark.el.width()}else if("y"==t)switch(e){case"top":i=0;break;case"middle":i=this.image.el.height()/2-this.watermark.el.height()/2;break;case"bottom":i=this.image.el.height()-this.watermark.el.height()}return i},clearForm:function(){$(".range-slider").slider("value",100),$("td").first().click(),$("form.upload").get(0).reset(),this.setImg("image",this.defaults.image),this.setImg("watermark",this.defaults.watermark)},submitForm:function(){var t={x:this.position.left,y:this.position.top,opacity:100*this.opacity,type:this.type};t.x=Math.round(t.x*this.image.r),t.y=Math.round(t.y*this.image.r),$.ajax({url:"/api/download",type:"POST",dataType:"json",data:t}).done(function(t){console.log("server success:",t);"/web/"+t.url;window.location="/api/download?file="+t.url,App.clearForm()}).fail(function(){console.log("server error")})}};window.App=App,$.widget("ui.spinner",$.ui.spinner,{_buttonHtml:function(){var t='<div class="regulate__trigger trigger--arrow"><button data-step="x-up" type="button" class="btn--up ui-spinner-button ui-spinner-up">Больше</button><button data-step="x-down" type="button" class="btn--down ui-spinner-button ui-spinner-down">Меньше</button></div>';return t},_uiSpinnerHtml:function(){return"<div class='my-spinner ui-spinner ui-widget ui-widget-content'></div>"}}),$(document).ready(function(){common.initEvents(),App.init(),$(document).on("keyup","#x",function(t){if(37!=t.keyCode&&39!=t.keyCode){var e=$(t.target),i=e.spinner("value");i<=e.spinner("option","max")&&i>=e.spinner("option","min")&&App.setPos({x:i})}}),$(document).on("keyup","#y",function(t){if(37!=t.keyCode&&39!=t.keyCode){var e=$(t.target),i=e.spinner("value");i<=e.spinner("option","max")&&i>=e.spinner("option","min")&&App.setPos({y:i})}}),$("#original-image").fileupload({dataType:"json",url:"/api/upload",done:function(t,e){status=e.jqXHR.status,200==status&&(resp=e.result,App.setImg("image",resp))},add:function(t,e){$("#original-image").siblings("input").val(e.files[0].name),e.submit()}}),$("#watermark").fileupload({dataType:"json",url:"/api/upload",done:function(t,e){status=e.jqXHR.status,200==status&&(resp=e.result,App.setImg("watermark",resp))},add:function(t,e){$("#watermark").siblings("input").val(e.files[0].name),e.submit()}}),$(".watermark").draggable({containment:"parent",stop:function(t,e){App.setPos({x:e.position.left,y:e.position.top})}}),$(".range-slider").slider({range:"min",value:100,min:1,max:100,slide:function(t,e){App.opacity=e.value/100,$(".watermark").css("opacity",App.opacity)},change:function(t,e){App.opacity=e.value/100,$(".watermark").css("opacity",App.opacity)}}),$("#x").spinner({min:0,max:450,step:1,spin:function(t,e){App.setPos({x:e.value})},change:function(t){var e=$(t.target);App.setPos({x:e.spinner("value")})}}),$("#y").spinner({min:0,max:335,step:1,spin:function(t,e){App.setPos({y:e.value})},change:function(t){var e=$(t.target);App.setPos({y:e.spinner("value")})}})});